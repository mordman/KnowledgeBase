## **2. Retry (Повторные попытки)**


## Оглавление
- [**2. Retry (Повторные попытки)**](#2-retry-повторные-попытки)
  - [**Цель**](#цель)
  - [**Принцип работы**](#принцип-работы)
  - [**Пример на C# (Polly)**](#пример-на-c-polly)
  - [**Пример с Kafka**](#пример-с-kafka)
  - [**Плюсы и минусы**](#плюсы-и-минусы)

  - [**Цель**](#цель)
  - [**Принцип работы**](#принцип-работы)
  - [**Пример на C# (Polly)**](#пример-на-c-polly)
  - [**Пример с Kafka**](#пример-с-kafka)
  - [**Плюсы и минусы**](#плюсы-и-минусы)
### **Цель**
Автоматически повторять failed операции, если ошибка временная (например, сетевые сбои, таймауты).

---

### **Принцип работы**
- Если операция завершилась с ошибкой, система автоматически повторяет её через заданный интервал.
- Часто используется с **экспоненциальной задержкой** (например, 1 сек, 2 сек, 4 сек).

---

### **Пример на C# (Polly)**
```csharp
using Polly;
using System;
using System.Net.Http;
using System.Threading.Tasks;

class Program
{
    static async Task Main()
    {
        var retryPolicy = Policy
            .Handle<HttpRequestException>()
            .WaitAndRetryAsync(
                retryCount: 3, // Количество попыток
                sleepDurationProvider: attempt => TimeSpan.FromSeconds(Math.Pow(2, attempt)), // Экспоненциальная задержка
                onRetry: (exception, delay) =>
                {
                    Console.WriteLine($"Попытка не удалась. Следующая через {delay.TotalSeconds} сек.");
                });

        HttpClient httpClient = new HttpClient();

        await retryPolicy.ExecuteAsync(async () =>
        {
            HttpResponseMessage response = await httpClient.GetAsync("https://example.com/api");
            response.EnsureSuccessStatusCode();
            Console.WriteLine("Запрос успешен!");
        });
    }
}
```

---

### **Пример с Kafka**
Если producer Kafka не может отправить сообщение из-за временной недоступности брокера:
```csharp
using Confluent.Kafka;
using Polly;
using System;
using System.Threading.Tasks;

class KafkaRetryExample
{
    static async Task Main()
    {
        var config = new ProducerConfig { BootstrapServers = "localhost:9092" };
        var retryPolicy = Policy
            .Handle<ProduceException<Null, string>>()
            .WaitAndRetryAsync(3, attempt => TimeSpan.FromSeconds(Math.Pow(2, attempt)));

        using (var producer = new ProducerBuilder<Null, string>(config).Build())
        {
            await retryPolicy.ExecuteAsync(async () =>
            {
                await producer.ProduceAsync("example-topic", new Message<Null, string> { Value = "Hello, Kafka!" });
                Console.WriteLine("Сообщение отправлено!");
            });
        }
    }
}
```

---

### **Плюсы и минусы**
| Плюсы                                      | Минусы                                      |
|--------------------------------------------|---------------------------------------------|
| Простота реализации.                       | Может усугубить нагрузку на неисправный сервис. |
| Эффективно для временных сбоев.           | Не подходит для неидемпотентных операций.   |