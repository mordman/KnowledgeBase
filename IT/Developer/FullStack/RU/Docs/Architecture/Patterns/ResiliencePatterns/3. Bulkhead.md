## **3. Bulkhead (Переборка)**


## Оглавление
- [**3. Bulkhead (Переборка)**](#3-bulkhead-переборка)
  - [**Цель**](#цель)
  - [**Принцип работы**](#принцип-работы)
  - [**Пример на C# (Polly)**](#пример-на-c-polly)
  - [**Пример с базой данных**](#пример-с-базой-данных)
  - [**Плюсы и минусы**](#плюсы-и-минусы)

  - [**Цель**](#цель)
  - [**Принцип работы**](#принцип-работы)
  - [**Пример на C# (Polly)**](#пример-на-c-polly)
  - [**Пример с базой данных**](#пример-с-базой-данных)
  - [**Плюсы и минусы**](#плюсы-и-минусы)
### **Цель**
Изолировать компоненты системы, чтобы сбой одного не влиял на другие (например, ограничение количества параллельных запросов к базе данных).

---

### **Принцип работы**
- Ограничивает количество параллельных операций для конкретного ресурса.
- Если лимит достигнут, новые запросы отклоняются или ставятся в очередь.

---

### **Пример на C# (Polly)**
```csharp
using Polly;
using Polly.Bulkhead;
using System;
using System.Threading.Tasks;

class Program
{
    static async Task Main()
    {
        var bulkheadPolicy = Policy
            .BulkheadAsync(
                maxParallelizations: 3, // Максимум 3 параллельных вызова
                maxQueuingActions: 2); // Максимум 2 запроса в очереди

        for (int i = 0; i < 10; i++)
        {
            try
            {
                await bulkheadPolicy.ExecuteAsync(async () =>
                {
                    Console.WriteLine($"Запрос {i} начат");
                    await Task.Delay(1000); // Имитация долгой операции
                    Console.WriteLine($"Запрос {i} завершён");
                });
            }
            catch (BulkheadRejectedException)
            {
                Console.WriteLine($"Запрос {i} отклонён: превышен лимит параллельных операций.");
            }
        }
    }
}
```

---

### **Пример с базой данных**
Ограничение количества параллельных запросов к базе данных:
```csharp
using Polly;
using System.Data.SqlClient;
using System.Threading.Tasks;

class BulkheadDatabaseExample
{
    static async Task Main()
    {
        var bulkheadPolicy = Policy.BulkheadAsync(5, 2); // Максимум 5 параллельных запросов

        for (int i = 0; i < 10; i++)
        {
            try
            {
                await bulkheadPolicy.ExecuteAsync(async () =>
                {
                    using (var connection = new SqlConnection("Server=localhost;Database=Example;"))
                    {
                        await connection.OpenAsync();
                        Console.WriteLine($"Запрос {i} выполнен");
                    }
                });
            }
            catch (BulkheadRejectedException)
            {
                Console.WriteLine($"Запрос {i} отклонён: превышен лимит.");
            }
        }
    }
}
```

---

### **Плюсы и минусы**
| Плюсы                                      | Минусы                                      |
|--------------------------------------------|---------------------------------------------|
| Изолирует сбои.                            | Требует балансировки ресурсов.              |
| Предотвращает перегрузку ресурсов.         | Может создать узкое место.                  |