**Event Sourcing** — это архитектурный подход, при котором **состояние системы определяется последовательностью событий**, а не текущими данными в базе. Вместо того чтобы хранить только актуальное состояние объектов, Event Sourcing сохраняет **все изменения (события)**, которые привели систему к текущему состоянию. Это позволяет восстановить состояние на любой момент времени, анализировать историю изменений и обеспечивать высокую надежность.

---

## **Основные принципы Event Sourcing**



## Оглавление
- [**Основные принципы Event Sourcing**](#основные-принципы-event-sourcing)
  - [1. **События как источник истины**](#1-события-как-источник-истины)
  - [2. **Восстановление состояния**](#2-восстановление-состояния)
  - [3. **Неизменяемость событий**](#3-неизменяемость-событий)
- [**Сценарии использования Event Sourcing**](#сценарии-использования-event-sourcing)
  - [1. **Финансовые системы**](#1-финансовые-системы)
  - [2. **Системы бронирования**](#2-системы-бронирования)
  - [3. **Игровые приложения**](#3-игровые-приложения)
  - [4. **Логистика и цепочки поставок**](#4-логистика-и-цепочки-поставок)
  - [5. **Аудит и соответствие требованиям**](#5-аудит-и-соответствие-требованиям)
- [**Преимущества Event Sourcing**](#преимущества-event-sourcing)
- [**Недостатки Event Sourcing**](#недостатки-event-sourcing)
- [**Пример реализации Event Sourcing**](#пример-реализации-event-sourcing)
  - [**1. Определение событий**](#1-определение-событий)
  - [**2. Хранение событий**](#2-хранение-событий)
  - [**3. Восстановление состояния**](#3-восстановление-состояния)
- [**Когда использовать Event Sourcing?**](#когда-использовать-event-sourcing)

  - [1. **События как источник истины**](#1-события-как-источник-истины)
  - [2. **Восстановление состояния**](#2-восстановление-состояния)
  - [3. **Неизменяемость событий**](#3-неизменяемость-событий)
  - [1. **Финансовые системы**](#1-финансовые-системы)
  - [2. **Системы бронирования**](#2-системы-бронирования)
  - [3. **Игровые приложения**](#3-игровые-приложения)
  - [4. **Логистика и цепочки поставок**](#4-логистика-и-цепочки-поставок)
  - [5. **Аудит и соответствие требованиям**](#5-аудит-и-соответствие-требованиям)
  - [**1. Определение событий**](#1-определение-событий)
  - [**2. Хранение событий**](#2-хранение-событий)
  - [**3. Восстановление состояния**](#3-восстановление-состояния)
### 1. **События как источник истины**
- Каждое изменение состояния системы фиксируется как **неизменяемое событие** (например, "Пользователь создан", "Заказ оплачен").
- События хранятся в **журнале событий (event store)**.

### 2. **Восстановление состояния**
- Текущее состояние объекта можно восстановить, **переиграв все события** с момента его создания.
- Пример: Чтобы узнать текущий баланс счета, суммируются все события пополнения и списания.

### 3. **Неизменяемость событий**
- События **никогда не изменяются и не удаляются**. Если нужно исправить ошибку, добавляется новое событие (например, "Корректировка заказа").

---

## **Сценарии использования Event Sourcing**

### 1. **Финансовые системы**
- **Пример:** Банковские счета, где важно отслеживать все транзакции для аудита и восстановления состояния.
- **Преимущество:** Легко восстановить баланс на любую дату, проверить историю операций.

### 2. **Системы бронирования**
- **Пример:** Авиабилеты, отели, где важно отслеживать все изменения статуса бронирования (создание, отмена, подтверждение).
- **Преимущество:** Можно восстановить состояние брони на любой момент времени.

### 3. **Игровые приложения**
- **Пример:** Онлайн-игры, где состояние игрока (уровень, инвентарь) определяется последовательностью действий.
- **Преимущество:** Легко откатить изменения или восстановить состояние после сбоя.

### 4. **Логистика и цепочки поставок**
- **Пример:** Отслеживание грузов, где важно знать историю перемещений и изменений статуса.
- **Преимущество:** Анализ истории для оптимизации маршрутов и выявления проблем.

### 5. **Аудит и соответствие требованиям**
- **Пример:** Системы, где требуется полная история изменений для соответствия регуляторным требованиям (например, GDPR, финансовые аудиты).
- **Преимущество:** Все изменения фиксируются и недоступны для подделки.

---

## **Преимущества Event Sourcing**
| Преимущество                     | Описание                                                                 |
|-----------------------------------|--------------------------------------------------------------------------|
| **Полная история изменений**      | Можно восстановить состояние системы на любой момент времени.          |
| **Аудит и прозрачность**         | Все действия пользователей и системы фиксируются.                     |
| **Откат изменений**               | Легко отменить ошибочные действия, добавив компенсирующее событие.       |
| **Масштабируемость**              | События можно обрабатывать асинхронно, что улучшает производительность. |
| **Гибкость**                      | Легко добавлять новые функции, анализируя исторические данные.          |

---

## **Недостатки Event Sourcing**
| Недостаток                        | Описание                                                                 |
|-----------------------------------|--------------------------------------------------------------------------|
| **Сложность реализации**          | Требует изменения подхода к проектированию и хранению данных.           |
| **Хранение больших объемов данных** | События накапливаются, что может потребовать оптимизации хранения.     |
| **Производительность при восстановлении** | Восстановление состояния может быть медленным, если событий много.     |

---

## **Пример реализации Event Sourcing**

### **1. Определение событий**
```csharp
public class UserCreatedEvent
{
    public int UserId { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
}

public class UserEmailChangedEvent
{
    public int UserId { get; set; }
    public string NewEmail { get; set; }
}
```

### **2. Хранение событий**
События сохраняются в **event store** (например, в специализированной базе данных или обычной реляционной базе с таблицей событий).

```csharp
public interface IEventStore
{
    Task SaveEventAsync<T>(T @event) where T : class;
    Task<List<T>> GetEventsAsync<T>(int aggregateId) where T : class;
}
```

### **3. Восстановление состояния**
```csharp
public class User
{
    public int Id { get; private set; }
    public string Name { get; private set; }
    public string Email { get; private set; }

    public void Apply(UserCreatedEvent @event)
    {
        Id = @event.UserId;
        Name = @event.Name;
        Email = @event.Email;
    }

    public void Apply(UserEmailChangedEvent @event)
    {
        Email = @event.NewEmail;
    }
}

// Восстановление пользователя из событий
public async Task<User> GetUserAsync(int userId)
{
    var user = new User();
    var events = await _eventStore.GetEventsAsync<UserCreatedEvent>(userId);
    events.ForEach(@event => user.Apply(@event));
    return user;
}
```

---

## **Когда использовать Event Sourcing?**
- Если вам нужна **полная история изменений** для аудита или анализа.
- Если вы хотите **восстанавливать состояние системы** на любой момент времени.
- Если ваша система **требует высокой надежности и прозрачности** (например, финансовые или логистические приложения).

---