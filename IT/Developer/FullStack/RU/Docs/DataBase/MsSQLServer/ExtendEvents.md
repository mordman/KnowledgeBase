**Extended Events (XEvents)** в Microsoft SQL Server — это современная, гибкая и лёгкая система для мониторинга и диагностики работы сервера. Она призвана заменить устаревший механизм SQL Trace и предлагает значительно больше возможностей с меньшими накладными расходами.

---

### **Основные возможности Extended Events**


## Оглавление
- [**Основные возможности Extended Events**](#основные-возможности-extended-events)
- [**Основные компоненты**](#основные-компоненты)
- [**Примеры использования**](#примеры-использования)
  - [1. **Создание простой сессии**](#1-создание-простой-сессии)
  - [2. **Запуск и остановка сессии**](#2-запуск-и-остановка-сессии)
  - [3. **Просмотр собранных данных**](#3-просмотр-собранных-данных)
- [**Популярные сценарии использования**](#популярные-сценарии-использования)
- [**Преимущества перед SQL Trace**](#преимущества-перед-sql-trace)
- [**Где узнать больше?**](#где-узнать-больше)

  - [1. **Создание простой сессии**](#1-создание-простой-сессии)
  - [2. **Запуск и остановка сессии**](#2-запуск-и-остановка-сессии)
  - [3. **Просмотр собранных данных**](#3-просмотр-собранных-данных)
- **Низкие накладные расходы**: Минимальное влияние на производительность сервера.
- **Гибкость**: Возможность настраивать события, цели и действия под конкретные задачи.
- **Расширяемость**: Поддержка пользовательских событий и целей.
- **Интеграция с T-SQL**: Управление через скрипты и системные представления.

---

### **Основные компоненты**
1. **События (Events)** — что происходит на сервере (например, `sql_statement_completed`, `deadlock`).
2. **Цели (Targets)** — куда сохраняются данные (например, файл, кольцевой буфер, системный журнал).
3. **Действия (Actions)** — дополнительные данные, которые можно собрать при срабатывании события (например, текст запроса, план выполнения).
4. **Сессии (Sessions)** — контейнер, объединяющий события, цели и действия.

---

### **Примеры использования**
#### 1. **Создание простой сессии**
```sql
CREATE EVENT SESSION [TrackDeadlocks] ON SERVER
ADD EVENT sqlserver.xml_deadlock_report
ADD TARGET package0.event_file(SET filename=N'C:\XEvents\Deadlocks.xel')
GO
```
Эта сессия будет записывать все дедлоки в файл `Deadlocks.xel`.

#### 2. **Запуск и остановка сессии**
```sql
ALTER EVENT SESSION [TrackDeadlocks] ON SERVER STATE = START;
ALTER EVENT SESSION [TrackDeadlocks] ON SERVER STATE = STOP;
```

#### 3. **Просмотр собранных данных**
```sql
SELECT
    event_data = CONVERT(XML, event_data)
FROM
    sys.fn_xe_file_target_read_file('C:\XEvents\Deadlocks*.xel', NULL, NULL, NULL)
GO
```

---

### **Популярные сценарии использования**
- **Диагностика производительности**: Отслеживание медленных запросов, блокировок, дедлоков.
- **Аудит безопасности**: Логирование попыток входа, изменений схемы, выполнения опасных команд.
- **Отладка**: Анализ ошибок, исключений и нештатных ситуаций.

---

### **Преимущества перед SQL Trace**
- **Меньше нагрузки на сервер**.
- **Больше гибкости** (можно собирать только нужные данные).
- **Лучшая интеграция с современными инструментами** (например, SQL Server Management Studio, Power BI).

---

### **Где узнать больше?**
- [Официальная документация Microsoft](https://learn.microsoft.com/ru-ru/sql/relational-databases/extended-events/extended-events)
- [Примеры сессий Extended Events](https://www.sqlshack.com/extended-events-sql-server/)

---