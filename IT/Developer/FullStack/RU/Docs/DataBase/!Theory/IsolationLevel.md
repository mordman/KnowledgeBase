## Уровни изоляции транзакций: теория и практика

Уровни изоляции транзакций определяют, как транзакции взаимодействуют друг с другом в многопользовательских системах управления базами данных (СУБД). Они регулируют баланс между **производительностью** и **корректностью данных**, предотвращая или допуская определённые аномалии (например, "грязное чтение", "неповторяющееся чтение", "фантомные записи").

---

## **1. Теоретическая часть**

### **1.1. Проблемы многопользовательского доступа**
В многопользовательских системах могут возникать следующие аномалии:

| **Аномалия**               | **Описание**                                                                                     |
|----------------------------|-------------------------------------------------------------------------------------------------|
| **Грязное чтение (Dirty Read)** | Транзакция читает данные, которые ещё не зафиксированы другой транзакцией и могут быть отменены. |
| **Неповторяющееся чтение (Non-Repeatable Read)** | Транзакция читает одну и ту же строку дважды, но между чтениями другая транзакция изменила её. |
| **Фантомное чтение (Phantom Read)** | Транзакция выполняет запрос дважды, но между выполнениями другая транзакция добавила или удалила строки, соответствующие условию запроса. |
| **Потерянное обновление (Lost Update)** | Две транзакции одновременно изменяют одну и ту же строку, и одно из изменений теряется. |

---

### **1.2. Уровни изоляции по стандарту ANSI/ISO SQL**

| **Уровень изоляции**       | **Грязное чтение** | **Неповторяющееся чтение** | **Фантомное чтение** | **Потерянное обновление** |
|----------------------------|--------------------|-----------------------------|-----------------------|---------------------------|
| **Read Uncommitted**       | Возможно           | Возможно                    | Возможно              | Возможно                 |
| **Read Committed**         | Невозможно         | Возможно                    | Возможно              | Возможно                 |
| **Repeatable Read**        | Невозможно         | Невозможно                  | Возможно              | Невозможно                |
| **Serializable**           | Невозможно         | Невозможно                  | Невозможно            | Невозможно                |

---

## **2. Практическая часть: уровни изоляции в различных СУБД**

### **2.1. PostgreSQL**

PostgreSQL поддерживает все четыре уровня изоляции, а также добавляет **уровень `Snapshot Isolation`** (аналог `Repeatable Read`, но с некоторыми отличиями).

#### **Примеры использования в PostgreSQL**

**Установка уровня изоляции:**
```sql
SET TRANSACTION ISOLATION LEVEL [READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE];
```

**Пример 1: Грязное чтение (Read Uncommitted)**
В PostgreSQL уровень `Read Uncommitted` ведёт себя как `Read Committed`, поэтому грязное чтение невозможно.

**Пример 2: Неповторяющееся чтение (Read Committed)**
```sql
-- Сессия 1:
BEGIN;
SELECT * FROM accounts WHERE id = 1; -- Возвращает баланс = 100

-- Сессия 2:
BEGIN;
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- Сессия 1:
SELECT * FROM accounts WHERE id = 1; -- Теперь возвращает баланс = 200 (неповторяющееся чтение)
COMMIT;
```

**Пример 3: Фантомное чтение (Repeatable Read)**
```sql
-- Сессия 1:
BEGIN;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM accounts WHERE balance > 50; -- Возвращает 2 строки

-- Сессия 2:
BEGIN;
INSERT INTO accounts VALUES (3, 300);
COMMIT;

-- Сессия 1:
SELECT * FROM accounts WHERE balance > 50; -- По-прежнему возвращает 2 строки (фантомное чтение отсутствует)
COMMIT;
```

---

### **2.2. MySQL/InnoDB**

MySQL поддерживает все четыре уровня изоляции, но по умолчанию используется `Repeatable Read`.

#### **Примеры использования в MySQL**

**Установка уровня изоляции:**
```sql
SET TRANSACTION ISOLATION LEVEL [READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE];
```

**Пример 1: Грязное чтение (Read Uncommitted)**
```sql
-- Сессия 1:
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
BEGIN;
UPDATE accounts SET balance = 200 WHERE id = 1; -- Не фиксируем!

-- Сессия 2:
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
BEGIN;
SELECT * FROM accounts WHERE id = 1; -- Возвращает баланс = 200 (грязное чтение)
COMMIT;
```

**Пример 2: Фантомное чтение (Repeatable Read)**
```sql
-- Сессия 1:
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN;
SELECT * FROM accounts WHERE balance > 50; -- Возвращает 2 строки

-- Сессия 2:
BEGIN;
INSERT INTO accounts VALUES (3, 300);
COMMIT;

-- Сессия 1:
SELECT * FROM accounts WHERE balance > 50; -- По-прежнему возвращает 2 строки (фантомное чтение отсутствует)
COMMIT;
```

---

### **2.3. Microsoft SQL Server**

SQL Server поддерживает все четыре уровня изоляции, а также добавляет **уровень `Snapshot Isolation`**.

#### **Примеры использования в SQL Server**

**Установка уровня изоляции:**
```sql
SET TRANSACTION ISOLATION LEVEL [READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE | SNAPSHOT];
```

**Пример 1: Snapshot Isolation**
```sql
-- Включаем Snapshot Isolation для базы данных:
ALTER DATABASE YourDatabase SET ALLOW_SNAPSHOT_ISOLATION ON;

-- Сессия 1:
SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
BEGIN TRANSACTION;
SELECT * FROM accounts WHERE id = 1; -- Возвращает баланс = 100

-- Сессия 2:
BEGIN TRANSACTION;
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- Сессия 1:
SELECT * FROM accounts WHERE id = 1; -- По-прежнему возвращает баланс = 100 (изоляция снимка)
COMMIT;
```

---

### **2.4. Oracle**

Oracle поддерживает уровни изоляции `Read Committed` (по умолчанию) и `Serializable`.

#### **Примеры использования в Oracle**

**Установка уровня изоляции:**
```sql
SET TRANSACTION ISOLATION LEVEL [READ COMMITTED | SERIALIZABLE];
```

**Пример 1: Serializable**
```sql
-- Сессия 1:
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
BEGIN;
SELECT * FROM accounts WHERE balance > 50; -- Возвращает 2 строки

-- Сессия 2:
BEGIN;
INSERT INTO accounts VALUES (3, 300);
COMMIT; -- Блокируется до завершения Сессии 1 (из-за Serializable)

-- Сессия 1:
SELECT * FROM accounts WHERE balance > 50; -- По-прежнему возвращает 2 строки
COMMIT;
```

---

## **3. Сценарии использования уровней изоляции**

| **Уровень изоляции**       | **Сценарий использования**                                                                 |
|----------------------------|-------------------------------------------------------------------------------------------|
| **Read Uncommitted**       | Редко используется. Может применяться в системах с низкими требованиями к корректности данных, где важна максимальная производительность. |
| **Read Committed**         | Стандартный уровень для большинства приложений (например, веб-приложения, CRM-системы). |
| **Repeatable Read**        | Приложения, где важно избежать неповторяющегося чтения (например, финансовые системы).     |
| **Serializable**           | Системы с жёсткими требованиями к корректности данных (например, банковские транзакции).   |
| **Snapshot Isolation**     | Приложения, где важно избежать блокировок, но допустимы небольшие задержки (например, аналитические системы). |

---

## **4. Заключение**

Выбор уровня изоляции зависит от требований к **корректности данных** и **производительности**:
- **Read Uncommitted** — максимальная производительность, минимальная корректность.
- **Read Committed** — баланс между производительностью и корректностью.
- **Repeatable Read** — высокая корректность, но возможны фантомные чтения.
- **Serializable** — максимальная корректность, но возможны блокировки и снижение производительности.