**VACUUM** в PostgreSQL — это процесс обслуживания базы данных, который выполняет несколько важных функций:

---

## **Зачем нужен VACUUM?**


## Оглавление
- [**Зачем нужен VACUUM?**](#зачем-нужен-vacuum)
- [**Типы VACUUM**](#типы-vacuum)
- [**Как использовать VACUUM?**](#как-использовать-vacuum)
  - [**1. Базовый VACUUM**](#1-базовый-vacuum)
  - [**2. VACUUM с анализом статистики**](#2-vacuum-с-анализом-статистики)
  - [**3. VACUUM FULL (полная очистка)**](#3-vacuum-full-полная-очистка)
  - [**4. Настройка AUTOVACUUM**](#4-настройка-autovacuum)
- [**Когда запускать VACUUM?**](#когда-запускать-vacuum)
- [**Практические советы**](#практические-советы)
- [Сравнение с MsSQL](#сравнение-с-mssql)
- [**1. Освобождение места: `DBCC SHRINKFILE` / `DBCC SHRINKDATABASE`**](#1-освобождение-места-dbcc-shrinkfile-dbcc-shrinkdatabase)
  - [**Пример:**](#пример)
- [**2. Обновление статистики: `UPDATE STATISTICS`**](#2-обновление-статистики-update-statistics)
  - [**Пример:**](#пример)
- [**3. Удаление фрагментации: `REORGANIZE` / `REBUILD` индексов**](#3-удаление-фрагментации-reorganize-rebuild-индексов)
  - [**Пример:**](#пример)
- [**4. Автоматическое управление: `Auto Shrink` и `Auto Update Statistics`**](#4-автоматическое-управление-auto-shrink-и-auto-update-statistics)
  - [**Пример настройки:**](#пример-настройки)
- [**Сравнение с PostgreSQL VACUUM**](#сравнение-с-postgresql-vacuum)
- [**Когда что использовать?**](#когда-что-использовать)

  - [**1. Базовый VACUUM**](#1-базовый-vacuum)
  - [**2. VACUUM с анализом статистики**](#2-vacuum-с-анализом-статистики)
  - [**3. VACUUM FULL (полная очистка)**](#3-vacuum-full-полная-очистка)
  - [**4. Настройка AUTOVACUUM**](#4-настройка-autovacuum)
  - [**Пример:**](#пример)
  - [**Пример:**](#пример)
  - [**Пример:**](#пример)
  - [**Пример настройки:**](#пример-настройки)
1. **Освобождение места**:
   PostgreSQL использует механизм **MVCC** (Multi-Version Concurrency Control), который сохраняет старые версии строк для транзакционной согласованности. Со временем эти устаревшие версии накапливаются и занимают место. `VACUUM` удаляет их, освобождая дисковое пространство.

2. **Обновление статистики**:
   `VACUUM` обновляет статистику, которую планировщик запросов использует для оптимизации выполнения SQL-запросов.

3. **Защита от транзакционного разрастания (transaction ID wraparound)**:
   В PostgreSQL каждая транзакция получает уникальный **Transaction ID (XID)**. Если XID переполняется (достигает максимума и сбрасывается), это может привести к остановке базы. `VACUUM` предотвращает эту проблему, "замораживая" старые строки.

---

## **Типы VACUUM**
| Тип                | Описание                                                                 | Команды                                                                 |
|--------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| **VACUUM**         | Стандартная очистка: удаляет "мёртвые" строки и обновляет статистику.   | `VACUUM [VERBOSE] [ANALYZE] [table_name];`                              |
| **VACUUM FULL**    | Полная перезапись таблицы для максимального освобождения места.         | `VACUUM (VERBOSE, FULL) table_name;`                                    |
| **VACUUM ANALYZE** | Очистка + обновление статистики для планировщика запросов.              | `VACUUM (VERBOSE, ANALYZE) table_name;`                                  |
| **AUTOVACUUM**     | Автоматический процесс, запускаемый PostgreSQL по расписанию.             | Настраивается в `postgresql.conf` или через `ALTER TABLE`.              |

---

## **Как использовать VACUUM?**

### **1. Базовый VACUUM**
```sql
-- Очистка одной таблицы
VACUUM users;

-- Очистка всей базы данных
VACUUM;
```

### **2. VACUUM с анализом статистики**
```sql
-- Очистка + обновление статистики
VACUUM (VERBOSE, ANALYZE) orders;
```

### **3. VACUUM FULL (полная очистка)**
```sql
-- Полная перезапись таблицы (блокирует таблицу на время выполнения!)
VACUUM (VERBOSE, FULL) logs;
```

### **4. Настройка AUTOVACUUM**
Автоматический `VACUUM` включается по умолчанию, но его параметры можно настроить:
```sql
-- Включить/отключить автоочистку для таблицы
ALTER TABLE large_table SET (autovacuum_enabled = on);

-- Настроить пороги срабатывания
ALTER TABLE large_table SET (autovacuum_vacuum_threshold = 500);
ALTER TABLE large_table SET (autovacuum_analyze_threshold = 300);
```

---

## **Когда запускать VACUUM?**
- **Регулярно**: Для таблиц с высокой частотой изменений (INSERT/UPDATE/DELETE).
- **После массовых операций**: Например, после удаления большого количества строк.
- **При нехватке места**: Если база раздулась из-за "мёртвых" строк.
- **Для предотвращения wraparound**: Если в логах появляются предупреждения о старых XID.

---

## **Практические советы**
- **Избегайте `VACUUM FULL` в рабочее время**: Он блокирует таблицу.
- **Мониторьте автоочистку**: Проверяйте логи на наличие ошибок или предупреждений.
- **Используйте `pg_stat_progress_vacuum`** (PostgreSQL 13+): Для отслеживания прогресса очистки.

---

## Сравнение с MsSQL

В **Microsoft SQL Server** аналогом команды `VACUUM` из PostgreSQL являются механизмы **управления свободным пространством** и **обновления статистики**, но они реализованы по-другому. Давайте разберём основные инструменты и их аналогию с `VACUUM`:

---

## **1. Освобождение места: `DBCC SHRINKFILE` / `DBCC SHRINKDATABASE`**
В PostgreSQL `VACUUM` удаляет "мёртвые" строки и освобождает место. В MS SQL Server для уменьшения размера файлов базы данных используются команды:

- **`DBCC SHRINKFILE`**: Уменьшает размер конкретного файла базы данных.
- **`DBCC SHRINKDATABASE`**: Уменьшает размер всех файлов базы данных.

### **Пример:**
```sql
-- Уменьшить размер файла данных
DBCC SHRINKFILE (N'YourDatabase_Data' , 1000); -- 1000 MB
GO

-- Уменьшить размер всей базы данных
DBCC SHRINKDATABASE (N'YourDatabase', 10); -- 10% свободного места
GO
```
**Важно:**
- Эти команды не удаляют "мёртвые" строки, а только освобождают неиспользуемое пространство.
- Частое использование может привести к фрагментации индексов.

---

## **2. Обновление статистики: `UPDATE STATISTICS`**
В PostgreSQL `VACUUM ANALYZE` обновляет статистику для планировщика запросов. В MS SQL Server для этого используется:

- **`UPDATE STATISTICS`**: Обновляет статистику для таблиц или индексов.

### **Пример:**
```sql
-- Обновить статистику для таблицы
UPDATE STATISTICS dbo.YourTable;
GO

-- Обновить статистику для всех таблиц в базе
EXEC sp_updatestats;
GO
```

---

## **3. Удаление фрагментации: `REORGANIZE` / `REBUILD` индексов**
В PostgreSQL `VACUUM FULL` перезаписывает таблицу для максимального освобождения места. В MS SQL Server аналогичный эффект достигается перестроением индексов:

- **`ALTER INDEX REORGANIZE`**: Дефрагментирует индекс без блокировки таблицы.
- **`ALTER INDEX REBUILD`**: Полностью перестраивает индекс (аналог `VACUUM FULL`).

### **Пример:**
```sql
-- Дефрагментация индекса
ALTER INDEX ALL ON dbo.YourTable REORGANIZE;
GO

-- Полное перестроение индекса
ALTER INDEX PK_YourTable ON dbo.YourTable REBUILD;
GO
```

---

## **4. Автоматическое управление: `Auto Shrink` и `Auto Update Statistics`**
MS SQL Server поддерживает автоматическое управление статистикой и освобождением места через настройки базы данных:

- **`AUTO_SHRINK`**: Автоматически уменьшает размер файлов (не рекомендуется включать).
- **`AUTO_UPDATE_STATISTICS`**: Автоматически обновляет статистику (включено по умолчанию).

### **Пример настройки:**
```sql
-- Включить автоматическое обновление статистики
ALTER DATABASE YourDatabase
SET AUTO_UPDATE_STATISTICS ON;
GO

-- Отключить автоматическое уменьшение файлов (рекомендуется)
ALTER DATABASE YourDatabase
SET AUTO_SHRINK OFF;
GO
```

---

## **Сравнение с PostgreSQL VACUUM**

| **Функция**               | **PostgreSQL**       | **MS SQL Server**                     |
|---------------------------|----------------------|---------------------------------------|
| Освобождение места        | `VACUUM`             | `DBCC SHRINKFILE` / `DBCC SHRINKDATABASE` |
| Обновление статистики     | `VACUUM ANALYZE`     | `UPDATE STATISTICS` / `sp_updatestats` |
| Полная перезапись таблицы | `VACUUM FULL`        | `ALTER INDEX REBUILD`                 |
| Автоматическая очистка    | `AUTOVACUUM`         | `AUTO_UPDATE_STATISTICS`              |

---

## **Когда что использовать?**
- **`DBCC SHRINKFILE`**: Если нужно освободить место после массового удаления данных.
- **`UPDATE STATISTICS`**: Если запросы стали медленнее из-за устаревшей статистики.
- **`REBUILD INDEX`**: Если индексы сильно фрагментированы (проверяйте через `sys.dm_db_index_physical_stats`).

---