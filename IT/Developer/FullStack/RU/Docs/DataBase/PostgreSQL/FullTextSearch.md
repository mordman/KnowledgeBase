## **1. Как работает `LIKE '%text%'`**
### **1.1. Проблема с `LIKE '%text%'`**
- **`LIKE '%text%'`** ищет **любое вхождение подстроки** в тексте.
- PostgreSQL **не может использовать B-Tree или другие стандартные индексы** для такого поиска, потому что:
  - Индексы оптимизированы для поиска **префиксов** (например, `LIKE 'text%'`).
  - Поиск по **произвольной подстроке** (`%text%`) требует сканирования всего текста.

#### **Пример**
```sql
-- Индекс не будет использован!
EXPLAIN ANALYZE
SELECT * FROM Articles WHERE Content LIKE '%PostgreSQL%';
```
- Результат: **`Seq Scan`** (полное сканирование таблицы).

---

## **2. Полнотекстовый поиск в PostgreSQL**
PostgreSQL предоставляет **специальные типы данных и функции** для полнотекстового поиска:
- **`tsvector`** — хранит лексически обработанный текст (токены, позиция слов).
- **`tsquery`** — хранит запрос для поиска (например, `'PostgreSQL & индексы'`).
- **Операторы `@@` (matching)** — проверяет, соответствует ли `tsvector` запросу `tsquery`.

### **2.1. Как работает полнотекстовый поиск**
1. **Текст преобразуется в `tsvector`**:
   - Удаляются стоп-слова (например, "и", "в", "на").
   - Слова приводятся к нормальной форме (лемматизация).
   - Пример:
     ```sql
     SELECT TO_TSVECTOR('russian', 'Изучаем PostgreSQL и его индексы');
     -- Результат: 'изуч':1 'postgresql':2 'индекс':4
     ```
2. **Запрос преобразуется в `tsquery`**:
   - Пример:
     ```sql
     SELECT TO_TSQUERY('russian', 'PostgreSQL & индексы');
     -- Результат: 'postgresql' & 'индекс'
     ```
3. **Поиск с использованием `@@`**:
   ```sql
   SELECT * FROM Articles
   WHERE TO_TSVECTOR('russian', Content) @@ TO_TSQUERY('russian', 'PostgreSQL & индексы');
   ```

---

### **2.2. Индексы для полнотекстового поиска**
Чтобы ускорить полнотекстовый поиск, создайте **GIN или GiST индекс** на столбце типа `tsvector`.

#### **Пример**
```sql
-- 1. Добавляем столбец для хранения tsvector
ALTER TABLE Articles ADD COLUMN SearchVector TSVECTOR;

-- 2. Заполняем столбец
UPDATE Articles SET SearchVector = TO_TSVECTOR('russian', Content);

-- 3. Создаём GIN индекс (рекомендуется для большинства случаев)
CREATE INDEX idx_articles_search ON Articles USING GIN (SearchVector);

-- 4. Используем в запросе
SELECT * FROM Articles
WHERE SearchVector @@ TO_TSQUERY('russian', 'PostgreSQL & индексы');
```
- **Результат:** PostgreSQL **использует индекс** (`Bitmap Heap Scan` или `Index Scan`).

---

### **2.3. Автоматическое обновление `tsvector`**
Чтобы `SearchVector` обновлялся автоматически при изменении `Content`, используйте **триггер**:
```sql
CREATE TRIGGER tsvector_update
BEFORE INSERT OR UPDATE ON Articles
FOR EACH ROW EXECUTE FUNCTION
TSVECTOR_UPDATE_TRIGGER('SearchVector', 'pg_catalog.russian', 'Content');
```

---

## **3. Сравнение `LIKE '%text%'` и полнотекстового поиска**
| **Характеристика**       | `LIKE '%text%'`                     | Полнотекстовый поиск (`tsvector` + `@@`) |
|---------------------------|-------------------------------------|------------------------------------------|
| **Использование индекса** | ❌ Нет                              | ✅ Да (GIN/GiST)                         |
| **Производительность**    | Медленно (полное сканирование)      | Быстро (использует индекс)              |
| **Морфология**            | ❌ Нет                              | ✅ Да (лемматизация)                     |
| **Стоп-слова**            | ❌ Учитываются                      | ✅ Игнорируются                          |
| **Ранжирование результатов** | ❌ Нет                           | ✅ Да (можно сортировать по релевантности) |

---

## **4. Когда использовать `LIKE '%text%'`**
- Только если **нужно найти точное вхождение подстроки** (например, поиск по коду или шаблону).
- Если **полнотекстовый поиск не подходит** (например, поиск по регулярным выражениям).

---

## **5. Пример: Поиск с ранжированием**
Можно сортировать результаты по релевантности с помощью `TS_RANK`:
```sql
SELECT
    Title,
    TS_RANK(SearchVector, TO_TSQUERY('russian', 'PostgreSQL & индексы')) AS Rank
FROM Articles
WHERE SearchVector @@ TO_TSQUERY('russian', 'PostgreSQL & индексы')
ORDER BY Rank DESC;
```

---

## **6. Выводы**
1. **`LIKE '%text%'` не использует индексы** и работает медленно.
2. **Для поиска по тексту используйте `tsvector` + `tsquery` + GIN/GiST индекс**.
3. **Настройте триггер** для автоматического обновления `tsvector`.
4. **Используйте `TS_RANK`** для сортировки по релевантности.